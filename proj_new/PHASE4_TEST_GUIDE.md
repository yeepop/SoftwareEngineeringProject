# Phase 4: 密碼重置流程測試指南

測試日期：_____________  
測試人員：_____________

---

## 📋 測試環境確認

- [ ] 後端服務運行正常 (http://localhost:5000)
- [ ] 前端服務運行正常 (http://localhost:5173)
- [ ] 資料庫連接正常
- [ ] 測試用戶已創建（test@example.com / Test1234）

---

## 🧪 測試區塊 A：忘記密碼流程

### A1. 正常流程 - 發送重置郵件

**步驟：**
1. 前往 http://localhost:5173/forgot-password
2. 輸入已存在的 email: `test@example.com`
3. 點擊「發送重置連結」

**預期結果：**
- ✅ 顯示成功訊息：「如果該 email 存在，密碼重置郵件已發送」
- ✅ 後端 console 顯示重置郵件內容（包含 token）
- ✅ 可從 console 複製 token

**實際結果：** ___________________

---

### A2. 不存在的 Email

**步驟：**
1. 前往忘記密碼頁面
2. 輸入不存在的 email: `nonexistent@example.com`
3. 提交表單

**預期結果：**
- ✅ 顯示相同成功訊息（不透露用戶是否存在）
- ✅ 後端不發送郵件（但不報錯）

**實際結果：** ___________________

---

### A3. 無效的 Email 格式

**步驟：**
1. 輸入無效 email: `invalid-email`
2. 嘗試提交

**預期結果：**
- ✅ HTML5 驗證阻止提交
- ✅ 顯示格式錯誤提示

**實際結果：** ___________________

---

### A4. API 直接測試 - 忘記密碼

**curl 命令：**
```bash
curl -X POST http://localhost:5000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com"
  }'
```

**預期結果：**
```json
{
  "message": "如果該 email 存在，密碼重置郵件已發送"
}
```

**實際結果：** ___________________

---

## 🧪 測試區塊 B：密碼重置流程

### B1. 正常流程 - 使用有效 Token 重置密碼

**步驟：**
1. 從 A1 步驟取得 token
2. 前往 http://localhost:5173/reset-password?token=YOUR_TOKEN
3. 輸入新密碼：`NewPass123`
4. 確認密碼：`NewPass123`
5. 點擊「重置密碼」

**預期結果：**
- ✅ 顯示密碼強度指標（4 個檢查項目）
- ✅ 重置成功訊息
- ✅ 提供「前往登入」按鈕
- ✅ 資料庫 `password_changed_at` 更新
- ✅ `failed_login_attempts` 重置為 0
- ✅ `locked_until` 清空

**實際結果：** ___________________

---

### B2. 使用新密碼登入

**步驟：**
1. 前往登入頁面
2. 使用舊密碼嘗試登入
3. 使用新密碼登入

**預期結果：**
- ✅ 舊密碼登入失敗
- ✅ 新密碼登入成功

**實際結果：** ___________________

---

### B3. 密碼不一致

**步驟：**
1. 前往重置密碼頁面（使用有效 token）
2. 新密碼：`NewPass123`
3. 確認密碼：`DifferentPass123`
4. 提交表單

**預期結果：**
- ✅ 顯示錯誤：「兩次輸入的密碼不一致」
- ✅ 按鈕保持禁用狀態

**實際結果：** ___________________

---

### B4. 密碼過短

**步驟：**
1. 輸入短密碼：`123`
2. 嘗試提交

**預期結果：**
- ✅ HTML5 驗證阻止（minlength="8"）
- ✅ 或顯示錯誤：「密碼長度至少需要 8 個字符」

**實際結果：** ___________________

---

### B5. 無效 Token

**步驟：**
1. 使用錯誤 token：http://localhost:5173/reset-password?token=invalid_token
2. 嘗試重置密碼

**預期結果：**
- ✅ 顯示錯誤：「重置 token 無效或已過期」
- ✅ 提供「重新申請重置」連結

**實際結果：** ___________________

---

### B6. 過期 Token

**測試方式：**
1. 取得 token
2. 等待 1 小時後使用（或修改 `max_age=3600` 為 `max_age=5` 測試）
3. 嘗試重置密碼

**預期結果：**
- ✅ 顯示錯誤：「重置 token 無效或已過期」

**實際結果：** ___________________

---

### B7. 沒有 Token 參數

**步驟：**
1. 直接訪問：http://localhost:5173/reset-password（無 token）

**預期結果：**
- ✅ 顯示錯誤訊息
- ✅ 提供返回申請重置的連結

**實際結果：** ___________________

---

### B8. API 直接測試 - 重置密碼

**curl 命令：**
```bash
# 先取得 token
curl -X POST http://localhost:5000/api/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email": "test@example.com"}'

# 使用 token 重置密碼
curl -X POST http://localhost:5000/api/auth/reset-password \
  -H "Content-Type: application/json" \
  -d '{
    "token": "YOUR_TOKEN_HERE",
    "new_password": "NewPassword123"
  }'
```

**預期結果：**
```json
{
  "message": "密碼重置成功，請使用新密碼登入",
  "success": true
}
```

**實際結果：** ___________________

---

## 🧪 測試區塊 C：審計日誌驗證

### C1. 檢查密碼重置審計記錄

**SQL 查詢：**
```sql
SELECT 
    audit_log_id,
    action,
    actor_id,
    target_type,
    target_id,
    before_state,
    after_state,
    timestamp
FROM audit_logs
WHERE action = 'user.password.reset'
ORDER BY timestamp DESC
LIMIT 5;
```

**預期結果：**
- ✅ 有記錄 `user.password.reset` 動作
- ✅ `actor_id` 等於用戶 ID
- ✅ `before_state` 和 `after_state` 有 password_hash（部分顯示）
- ✅ `timestamp` 正確

**實際結果：** ___________________

---

## 🧪 測試區塊 D：安全性測試

### D1. 多次重置請求

**步驟：**
1. 連續 5 次提交忘記密碼請求（相同 email）
2. 觀察系統行為

**預期結果：**
- ✅ 所有請求均成功（無 rate limiting 錯誤）
- ✅ 每次生成新 token
- ✅ 舊 token 仍然有效（直到過期）

**建議改進：**
- [ ] 考慮添加 rate limiting（同一 IP 限制）
- [ ] 考慮使舊 token 失效

**實際結果：** ___________________

---

### D2. Token 重複使用

**步驟：**
1. 使用 token 成功重置密碼
2. 再次使用相同 token 嘗試重置

**預期結果：**
- ✅ 第一次成功
- ✅ 第二次仍然成功（token 本身未標記為已使用）

**建議改進：**
- [ ] 考慮在資料庫記錄已使用的 token
- [ ] 或在重置後立即使 token 失效

**實際結果：** ___________________

---

### D3. SQL Injection 測試

**測試輸入：**
```
email: admin'--
email: ' OR '1'='1
```

**預期結果：**
- ✅ 正常返回成功訊息（不透露信息）
- ✅ 無 SQL 錯誤
- ✅ SQLAlchemy ORM 自動防護

**實際結果：** ___________________

---

## 🧪 測試區塊 E：UI/UX 測試

### E1. 密碼強度指示器

**步驟：**
1. 前往重置密碼頁面
2. 依序輸入：
   - `abc` (無大寫、無數字)
   - `Abc` (有大寫、無數字)
   - `Abc123` (有大寫、有數字)
   - `Abc12345` (滿足所有條件)

**預期結果：**
- ✅ 即時顯示各項檢查結果
- ✅ 符合條件的項目顯示綠色 ✓
- ✅ 不符合的顯示灰色

**實際結果：** ___________________

---

### E2. 載入狀態

**步驟：**
1. 提交重置請求
2. 觀察按鈕狀態

**預期結果：**
- ✅ 按鈕顯示 loading 動畫
- ✅ 按鈕禁用防止重複提交
- ✅ 完成後恢復正常

**實際結果：** ___________________

---

### E3. 響應式設計

**測試裝置：**
- [ ] 桌面 (1920x1080)
- [ ] 平板 (768x1024)
- [ ] 手機 (375x667)

**預期結果：**
- ✅ 所有裝置顯示正常
- ✅ 表單可讀可用
- ✅ 按鈕大小適中

**實際結果：** ___________________

---

## 🧪 測試區塊 F：整合測試

### F1. 完整流程測試

**步驟：**
1. 註冊新用戶
2. 登入一次確認密碼正確
3. 忘記密碼
4. 取得重置 token
5. 重置密碼
6. 使用新密碼登入
7. 檢查審計日誌

**預期結果：**
- ✅ 所有步驟順利完成
- ✅ 新密碼生效
- ✅ 有完整審計記錄

**實際結果：** ___________________

---

### F2. 帳號鎖定後重置密碼

**步驟：**
1. 故意輸錯密碼 5 次（觸發鎖定）
2. 使用忘記密碼功能重置
3. 嘗試登入

**預期結果：**
- ✅ 帳號被鎖定
- ✅ 重置密碼後 `locked_until` 清空
- ✅ 可以正常登入

**實際結果：** ___________________

---

## 📊 測試總結

### 通過的測試
- [ ] A1-A4: 忘記密碼流程
- [ ] B1-B8: 密碼重置流程
- [ ] C1: 審計日誌
- [ ] D1-D3: 安全性測試
- [ ] E1-E3: UI/UX 測試
- [ ] F1-F2: 整合測試

### 發現的問題
1. _____________________________
2. _____________________________
3. _____________________________

### 需要改進的地方
1. _____________________________
2. _____________________________
3. _____________________________

### 測試結論
- [ ] ✅ 所有核心功能正常
- [ ] ⚠️ 部分功能需要改進
- [ ] ❌ 發現重大問題，需修復

---

**測試完成日期：** _____________  
**下一步行動：** _____________
