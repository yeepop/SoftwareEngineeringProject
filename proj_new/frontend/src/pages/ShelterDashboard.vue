<template>
  <div class="shelter-dashboard">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
      <h1 class="text-3xl font-bold text-gray-900 mb-8">æ”¶å®¹æ‰€ç®¡ç†</h1>
      
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8">
        <div class="flex items-start gap-3">
          <div class="text-2xl">â„¹ï¸</div>
          <div>
            <h2 class="text-lg font-semibold text-blue-900 mb-2">æ”¶å®¹æ‰€æœƒå“¡æ¬Šé™èªªæ˜</h2>
            <p class="text-blue-800 mb-2">æ”¶å®¹æ‰€æœƒå“¡çš„æ¬Šé™èˆ‡ä¸€èˆ¬æœƒå“¡ç›¸åŒ,ä¸»è¦å·®ç•°åœ¨æ–¼:</p>
            <ul class="list-disc list-inside text-blue-800 space-y-1">
              <li>å¯ä½¿ç”¨æ‰¹æ¬¡æ“ä½œåŠŸèƒ½,å¿«é€Ÿå»ºç«‹å¤šç­†é€é¤Šå‹•ç‰©è³‡æ–™</li>
              <li>å¯çµ±ä¸€ç®¡ç†æ”¶å®¹æ‰€çš„é€é¤Šå‹•ç‰©</li>
              <li>æ“æœ‰å°ˆå±¬çš„ç®¡ç†ä»‹é¢,æ–¹ä¾¿é€²è¡Œå¤§é‡æ“ä½œ</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- å¿«é€Ÿé€£çµ -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
        <button
          @click="router.push('/my-rehomes')"
          class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition text-left"
        >
          <div class="flex items-center gap-3">
            <div class="text-4xl">ï¿½</div>
            <div>
              <p class="text-lg font-semibold text-gray-900">æˆ‘çš„é€é¤Š</p>
              <p class="text-sm text-gray-600">ç®¡ç†é€é¤Šå‹•ç‰©</p>
            </div>
          </div>
        </button>

        <button
          @click="router.push('/admin/applications')"
          class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition text-left"
        >
          <div class="flex items-center gap-3">
            <div class="text-4xl">ğŸ“‹</div>
            <div>
              <p class="text-lg font-semibold text-gray-900">é ˜é¤Šç”³è«‹ç®¡ç†</p>
              <p class="text-sm text-gray-600">å¯©æ ¸é ˜é¤Šç”³è«‹</p>
            </div>
          </div>
        </button>

        <button
          @click="router.push('/medical-records')"
          class="bg-white rounded-lg shadow p-6 hover:shadow-lg transition text-left"
        >
          <div class="flex items-center gap-3">
            <div class="text-4xl">ğŸ¥</div>
            <div>
              <p class="text-lg font-semibold text-gray-900">é†«ç™‚è¨˜éŒ„</p>
              <p class="text-sm text-gray-600">ç®¡ç†å‹•ç‰©é†«ç™‚è¨˜éŒ„</p>
            </div>
          </div>
        </button>
      </div>

      <!-- æ‰¹æ¬¡åŒ¯å…¥å‹•ç‰©è³‡æ–™ -->
      <div class="bg-white rounded-lg shadow p-8 mb-8">
        <div class="flex items-center gap-3 mb-6">
          <div class="text-3xl">âš¡</div>
          <h2 class="text-xl font-bold text-gray-900">æ‰¹æ¬¡åŒ¯å…¥å‹•ç‰©è³‡æ–™</h2>
        </div>

        <!-- èªªæ˜å€ -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-blue-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="flex-1">
              <p class="text-sm font-semibold text-blue-900 mb-2">æ‰¹æ¬¡åŒ¯å…¥æ”¯æ´ä¸‰ç¨®æª”æ¡ˆé¡å‹:</p>
              <ul class="text-xs text-blue-800 space-y-1 list-disc list-inside">
                <li><strong>å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV (å¿…å¡«):</strong> åŒ…å«åç¨±ã€ç‰©ç¨®ã€å“ç¨®ç­‰åŸºæœ¬è³‡è¨Š</li>
                <li><strong>é†«ç™‚è¨˜éŒ„ CSV (é¸å¡«):</strong> åŒ…å«å¤šç­†é†«ç™‚è¨˜éŒ„,é€éå‹•ç‰©ç·¨è™Ÿé—œè¯</li>
                <li><strong>ç…§ç‰‡è³‡æ–™å¤¾ (é¸å¡«):</strong> ç…§ç‰‡æª”åæ ¼å¼: å‹•ç‰©ç·¨è™Ÿ_é †åº.jpg (ä¾‹: 001_1.jpg, 001_2.jpg)</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- CSV ç¯„æœ¬ä¸‹è¼‰ -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4 mb-6">
          <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-indigo-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="flex-1">
              <p class="text-sm text-indigo-800 mb-3"><strong>è«‹å…ˆä¸‹è¼‰ç¯„æœ¬æª”æ¡ˆ:</strong></p>
              <div class="flex gap-2 mb-3">
                <button
                  @click="downloadAnimalTemplate"
                  class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded transition"
                >
                  ğŸ“¥ ä¸‹è¼‰å‹•ç‰©åŸºæœ¬è³‡è¨Šç¯„æœ¬
                </button>
                <button
                  @click="downloadMedicalTemplate"
                  class="text-sm bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded transition"
                >
                  ğŸ“¥ ä¸‹è¼‰é†«ç™‚è¨˜éŒ„ç¯„æœ¬
                </button>
              </div>
              <div class="text-xs text-indigo-700 space-y-1">
                <p><strong>å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV æ¬„ä½èªªæ˜:</strong></p>
                <ul class="list-disc list-inside ml-2 mb-2">
                  <li><strong>å¿…å¡«:</strong> animal_code, name, species, breed, sex, dob, color, description</li>
                  <li><strong>animal_code:</strong> å‹•ç‰©ç·¨è™Ÿ (è‡ªè¡Œç·¨ç¢¼,ç”¨æ–¼é—œè¯ç…§ç‰‡å’Œé†«ç™‚è¨˜éŒ„,ä¾‹: 001, 002, A001)</li>
                  <li><strong>species:</strong> CAT æˆ– DOG</li>
                  <li><strong>sex:</strong> MALE æˆ– FEMALE</li>
                  <li><strong>dob:</strong> å‡ºç”Ÿæ—¥æœŸ YYYY-MM-DD (ä¾‹: 2023-01-15)</li>
                </ul>
                <p><strong>é†«ç™‚è¨˜éŒ„ CSV æ¬„ä½èªªæ˜:</strong></p>
                <ul class="list-disc list-inside ml-2">
                  <li><strong>å¿…å¡«:</strong> animal_code, record_type, date</li>
                  <li><strong>animal_code:</strong> å°æ‡‰å‹•ç‰©åŸºæœ¬è³‡è¨Šçš„ç·¨è™Ÿ</li>
                  <li><strong>record_type:</strong> TREATMENT, CHECKUP, VACCINE, SURGERY, OTHER</li>
                  <li><strong>date:</strong> é†«ç™‚æ—¥æœŸ YYYY-MM-DD</li>
                  <li><strong>é¸å¡«:</strong> provider, details</li>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            <span class="text-red-600">*</span> å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV (å¿…å¡«)
          </label>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-indigo-400 transition">
            <input
              type="file"
              ref="animalCsvInput"
              @change="handleAnimalCsvSelect"
              accept=".csv"
              class="hidden"
            />
            <button
              @click="animalCsvInput?.click()"
              class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
              :disabled="isUploading"
            >
              <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              é¸æ“‡å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV
            </button>
            <p class="text-sm text-gray-500 mt-2">å¿…å¡«: åŒ…å«å‹•ç‰©çš„åŸºæœ¬è³‡è¨Š</p>
          </div>

          <div v-if="animalCsvFile" class="mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium text-gray-900">{{ animalCsvFile.name }}</span>
                <span class="text-xs text-gray-500">({{ formatFileSize(animalCsvFile.size) }})</span>
              </div>
              <button @click="clearAnimalCsv" class="text-red-600 hover:text-red-700" :disabled="isUploading">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- é†«ç™‚è¨˜éŒ„ CSV (é¸å¡«) -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">é†«ç™‚è¨˜éŒ„ CSV (é¸å¡«)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition">
            <input
              type="file"
              ref="medicalCsvInput"
              @change="handleMedicalCsvSelect"
              accept=".csv"
              class="hidden"
            />
            <button
              @click="medicalCsvInput?.click()"
              class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
              :disabled="isUploading"
            >
              <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              é¸æ“‡é†«ç™‚è¨˜éŒ„ CSV
            </button>
            <p class="text-sm text-gray-500 mt-2">é¸å¡«: å¯åŒ…å«å¤šç­†é†«ç™‚è¨˜éŒ„</p>
          </div>

          <div v-if="medicalCsvFile" class="mt-3 bg-purple-50 border border-purple-200 rounded-lg p-3">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium text-gray-900">{{ medicalCsvFile.name }}</span>
                <span class="text-xs text-gray-500">({{ formatFileSize(medicalCsvFile.size) }})</span>
              </div>
              <button @click="clearMedicalCsv" class="text-red-600 hover:text-red-700" :disabled="isUploading">
                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- ç…§ç‰‡æ‰¹æ¬¡ä¸Šå‚³ (é¸å¡«) -->
        <div class="mb-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">å‹•ç‰©ç…§ç‰‡ (é¸å¡«)</label>
          <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-green-400 transition">
            <input
              type="file"
              ref="photosInput"
              @change="handlePhotosSelect"
              accept="image/*"
              multiple
              class="hidden"
            />
            <button
              @click="photosInput?.click()"
              class="inline-flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition"
              :disabled="isUploading"
            >
              <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              é¸æ“‡å‹•ç‰©ç…§ç‰‡
            </button>
            <p class="text-sm text-gray-500 mt-2">é¸å¡«: æª”åæ ¼å¼ å‹•ç‰©ç·¨è™Ÿ_é †åº.jpg (ä¾‹: 001_1.jpg)</p>
          </div>

          <div v-if="photoFiles.length > 0" class="mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm font-medium text-gray-900">å·²é¸æ“‡ {{ photoFiles.length }} å¼µç…§ç‰‡</span>
              <button @click="clearPhotos" class="text-red-600 hover:text-red-700 text-sm" :disabled="isUploading">
                æ¸…é™¤å…¨éƒ¨
              </button>
            </div>
            <div class="grid grid-cols-4 gap-2 max-h-40 overflow-y-auto">
              <div v-for="(file, index) in photoFiles.slice(0, 12)" :key="index" class="relative">
                <img :src="getPhotoPreview(file)" class="w-full h-20 object-cover rounded" />
                <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs px-1 truncate">
                  {{ file.name }}
                </div>
              </div>
            </div>
            <p v-if="photoFiles.length > 12" class="text-xs text-gray-600 mt-2">
              é‚„æœ‰ {{ photoFiles.length - 12 }} å¼µç…§ç‰‡æœªé¡¯ç¤º
            </p>
          </div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯ -->
        <div v-if="errorMessage" class="mb-4 bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-sm text-red-800">{{ errorMessage }}</p>
        </div>

        <!-- ä¸Šå‚³æŒ‰éˆ• -->
        <button
          @click="uploadBatch"
          :disabled="!animalCsvFile || isUploading"
          class="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white py-3 px-6 rounded-lg font-medium transition"
        >
          {{ isUploading ? 'ä¸Šå‚³ä¸­...' : 'é–‹å§‹æ‰¹æ¬¡åŒ¯å…¥' }}
        </button>
      </div>

      <!-- åŒ¯å…¥æ­·å²è¨˜éŒ„ -->
      <div class="bg-white rounded-lg shadow p-8">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold text-gray-900">åŒ¯å…¥æ­·å²è¨˜éŒ„</h2>
          <button
            @click="loadJobs"
            class="text-sm text-indigo-600 hover:text-indigo-700 transition"
            :disabled="loadingJobs"
          >
            ğŸ”„ é‡æ–°æ•´ç†
          </button>
        </div>

        <!-- è¼‰å…¥ä¸­ -->
        <div v-if="loadingJobs" class="text-center py-8">
          <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>

        <!-- è¨˜éŒ„åˆ—è¡¨ -->
        <div v-else-if="jobs.length > 0" class="space-y-4">
          <div
            v-for="job in jobs"
            :key="job.job_id"
            class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition"
          >
            <div class="flex items-start justify-between mb-3">
              <div>
                <div class="flex items-center gap-2 mb-1">
                  <span class="font-medium text-gray-900">æ‰¹æ¬¡åŒ¯å…¥ä»»å‹™ #{{ job.job_id }}</span>
                  <span
                    :class="{
                      'bg-yellow-100 text-yellow-800': job.status === 'PENDING',
                      'bg-blue-100 text-blue-800': job.status === 'RUNNING',
                      'bg-green-100 text-green-800': job.status === 'SUCCEEDED',
                      'bg-red-100 text-red-800': job.status === 'FAILED'
                    }"
                    class="px-2 py-0.5 rounded text-xs font-medium"
                  >
                    {{ getJobStatusText(job.status) }}
                  </span>
                </div>
                <p class="text-sm text-gray-500">å»ºç«‹æ™‚é–“: {{ formatDate(job.created_at) }}</p>
              </div>
            </div>

            <!-- é€²åº¦è³‡è¨Š -->
            <div v-if="job.result_summary" class="bg-gray-50 rounded p-3 text-sm">
              <div v-if="job.status === 'SUCCEEDED'" class="space-y-1">
                <p class="text-green-800"><strong>âœ“ åŒ¯å…¥æˆåŠŸ</strong></p>
                <p class="text-gray-700">ç¸½è¨ˆ: {{ job.result_summary.total_rows }} ç­†</p>
                <p class="text-gray-700">æˆåŠŸ: {{ job.result_summary.success_count }} ç­†</p>
                <p class="text-gray-700">å¤±æ•—: {{ job.result_summary.failed_count }} ç­†</p>
              </div>
              <div v-else-if="job.status === 'FAILED'" class="text-red-800">
                <p><strong>âœ— åŒ¯å…¥å¤±æ•—</strong></p>
                <p class="text-sm mt-1">{{ job.result_summary.error }}</p>
              </div>
              <div v-else-if="job.status === 'RUNNING'" class="text-blue-800">
                <p>â³ æ­£åœ¨è™•ç†ä¸­...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- ç©ºç‹€æ…‹ -->
        <div v-else class="text-center py-8 text-gray-500">
          <svg class="h-12 w-12 mx-auto mb-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>å°šç„¡åŒ¯å…¥è¨˜éŒ„</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { useAuthStore } from '@/stores/auth'
import { getJobs } from '@/api/jobs'
import type { Job } from '@/types/models'
import api from '@/api/client'

const router = useRouter()
const authStore = useAuthStore()

// æª”æ¡ˆè¼¸å…¥ refs
const animalCsvInput = ref<HTMLInputElement>()
const medicalCsvInput = ref<HTMLInputElement>()
const photosInput = ref<HTMLInputElement>()

// æª”æ¡ˆç‹€æ…‹
const animalCsvFile = ref<File | null>(null)
const medicalCsvFile = ref<File | null>(null)
const photoFiles = ref<File[]>([])

const isUploading = ref(false)
const errorMessage = ref('')
const jobs = ref<Job[]>([])
const loadingJobs = ref(false)

onMounted(() => {
  loadJobs()
})

// ===== å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV =====
function handleAnimalCsvSelect(event: Event) {
  const target = event.target as HTMLInputElement
  if (target.files && target.files[0]) {
    const file = target.files[0]
    
    if (!file.name.endsWith('.csv')) {
      errorMessage.value = 'è«‹é¸æ“‡ CSV æª”æ¡ˆ'
      return
    }
    
    if (file.size > 10 * 1024 * 1024) {
      errorMessage.value = 'æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 10MB'
      return
    }
    
    animalCsvFile.value = file
    errorMessage.value = ''
  }
}

function clearAnimalCsv() {
  animalCsvFile.value = null
  if (animalCsvInput.value) {
    animalCsvInput.value.value = ''
  }
}

// ===== é†«ç™‚è¨˜éŒ„ CSV =====
function handleMedicalCsvSelect(event: Event) {
  const target = event.target as HTMLInputElement
  if (target.files && target.files[0]) {
    const file = target.files[0]
    
    if (!file.name.endsWith('.csv')) {
      errorMessage.value = 'è«‹é¸æ“‡ CSV æª”æ¡ˆ'
      return
    }
    
    if (file.size > 10 * 1024 * 1024) {
      errorMessage.value = 'æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é 10MB'
      return
    }
    
    medicalCsvFile.value = file
    errorMessage.value = ''
  }
}

function clearMedicalCsv() {
  medicalCsvFile.value = null
  if (medicalCsvInput.value) {
    medicalCsvInput.value.value = ''
  }
}

// ===== ç…§ç‰‡é¸æ“‡ =====
function handlePhotosSelect(event: Event) {
  const target = event.target as HTMLInputElement
  if (target.files && target.files.length > 0) {
    const files = Array.from(target.files)
    
    // é©—è­‰æª”æ¡ˆé¡å‹
    const invalidFiles = files.filter(f => !f.type.startsWith('image/'))
    if (invalidFiles.length > 0) {
      errorMessage.value = `æœ‰ ${invalidFiles.length} å€‹æª”æ¡ˆä¸æ˜¯åœ–ç‰‡æ ¼å¼`
      return
    }
    
    // é©—è­‰æª”æ¡ˆå¤§å°
    const oversizeFiles = files.filter(f => f.size > 5 * 1024 * 1024)
    if (oversizeFiles.length > 0) {
      errorMessage.value = `æœ‰ ${oversizeFiles.length} å€‹æª”æ¡ˆè¶…é 5MB`
      return
    }
    
    photoFiles.value = files
    errorMessage.value = ''
  }
}

function clearPhotos() {
  photoFiles.value = []
  if (photosInput.value) {
    photosInput.value.value = ''
  }
}

function getPhotoPreview(file: File): string {
  return URL.createObjectURL(file)
}

// ===== æ‰¹æ¬¡ä¸Šå‚³ =====
async function uploadBatch() {
  if (!animalCsvFile.value) {
    errorMessage.value = 'è«‹å…ˆé¸æ“‡å‹•ç‰©åŸºæœ¬è³‡è¨Š CSV æª”æ¡ˆ'
    return
  }
  
  if (!authStore.user?.primary_shelter_id) {
    errorMessage.value = 'æ‚¨ä¸æ˜¯æ”¶å®¹æ‰€æœƒå“¡,ç„¡æ³•ä½¿ç”¨æ‰¹æ¬¡åŒ¯å…¥åŠŸèƒ½'
    return
  }
  
  isUploading.value = true
  errorMessage.value = ''
  
  try {
    // Debug: æª¢æŸ¥æª”æ¡ˆç‰©ä»¶
    console.log('[DEBUG] animalCsvFile:', animalCsvFile.value)
    console.log('[DEBUG] animalCsvFile type:', animalCsvFile.value?.constructor.name)
    console.log('[DEBUG] medicalCsvFile:', medicalCsvFile.value)
    console.log('[DEBUG] photoFiles count:', photoFiles.value.length)
    
    // ä½¿ç”¨ FormData ä¸Šå‚³å¤šå€‹æª”æ¡ˆ
    const formData = new FormData()
    formData.append('animal_csv', animalCsvFile.value)
    
    if (medicalCsvFile.value) {
      formData.append('medical_csv', medicalCsvFile.value)
    }
    
    // ä¸Šå‚³æ‰€æœ‰ç…§ç‰‡
    photoFiles.value.forEach((file) => {
      formData.append('photos', file)
    })
    
    // Debug: æª¢æŸ¥ FormData å…§å®¹
    console.log('[DEBUG] FormData entries:')
    for (let pair of formData.entries()) {
      console.log(`  ${pair[0]}:`, pair[1])
    }
    
    // FormData æœƒè¢« interceptor è‡ªå‹•è™•ç†,ç§»é™¤é è¨­çš„ Content-Type
    const response = await api.post(
      `/shelters/${authStore.user.primary_shelter_id}/animals/batch`,
      formData
    )
    
    alert(`æ‰¹æ¬¡åŒ¯å…¥å·²åŠ å…¥éšŠåˆ—!\nä»»å‹™ ID: ${response.data.job_id}\n\nè«‹åœ¨ä¸‹æ–¹ã€ŒåŒ¯å…¥æ­·å²è¨˜éŒ„ã€ä¸­æŸ¥çœ‹é€²åº¦`)
    
    // æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆé¸æ“‡
    clearAnimalCsv()
    clearMedicalCsv()
    clearPhotos()
    
    // é‡æ–°è¼‰å…¥ä»»å‹™åˆ—è¡¨
    await loadJobs()
    
  } catch (err: any) {
    console.error('Upload error:', err)
    console.error('Error response:', err.response?.data)
    console.error('Error status:', err.response?.status)
    console.error('Error message:', err.response?.data?.message)
    errorMessage.value = err.response?.data?.message || 'ä¸Šå‚³å¤±æ•—,è«‹ç¨å¾Œå†è©¦'
  } finally {
    isUploading.value = false
  }
}

// ===== Jobs ç®¡ç† =====
async function loadJobs() {
  loadingJobs.value = true
  
  try {
    const response = await getJobs({
      type: 'IMPORT_ANIMALS',
      per_page: 10
    })
    jobs.value = response.jobs
  } catch (err) {
    console.error('Failed to load jobs:', err)
  } finally {
    loadingJobs.value = false
  }
}

// ===== ç¯„æœ¬ä¸‹è¼‰ =====
function downloadAnimalTemplate() {
  const csvContent = `animal_code,name,species,breed,sex,dob,color,description
001,Buddy,DOG,Mixed Breed,MALE,2023-01-15,White,Friendly and energetic dog suitable for families
002,Whiskers,CAT,Orange Tabby,FEMALE,2024-03-20,Orange,Quiet and gentle cat who loves sunbathing
003,Max,DOG,Labrador,MALE,2022-06-10,Black,Gentle and friendly large dog suitable for experienced owners
004,Luna,CAT,Mixed Breed,FEMALE,2023-08-05,Calico,Affectionate cat who loves attention and is litter trained`
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = 'animals_template.csv'
  link.click()
}

function downloadMedicalTemplate() {
  const csvContent = `animal_code,record_type,date,provider,details
001,VACCINE,2024-09-15,City Animal Hospital,Rabies vaccination completed
001,SURGERY,2024-03-10,Love & Care Veterinary,Neutering surgery recovery excellent
002,CHECKUP,2024-10-01,Pet Health Center,Annual health check normal no abnormalities
003,VACCINE,2024-08-20,Animal Shelter Clinic,Three-in-one vaccine administered
003,TREATMENT,2024-07-15,Animal Hospital,Skin treatment fully recovered`
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = 'medical_records_template.csv'
  link.click()
}

// ===== å·¥å…·å‡½æ•¸ =====
function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`
  return `${(bytes / (1024 * 1024)).toFixed(2)} MB`
}

function formatDate(dateString: string): string {
  return new Date(dateString).toLocaleString('zh-TW')
}

function getJobStatusText(status: string): string {
  const statusMap: Record<string, string> = {
    'PENDING': 'ç­‰å¾…ä¸­',
    'RUNNING': 'è™•ç†ä¸­',
    'SUCCEEDED': 'æˆåŠŸ',
    'FAILED': 'å¤±æ•—'
  }
  return statusMap[status] || status
}
</script>
